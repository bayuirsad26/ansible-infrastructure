#!/bin/bash
# Simple system backup script
# Managed by Ansible - Do not edit manually

set -euo pipefail

# Configuration
BACKUP_DIR="{{ backup_local_path }}"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
LOG_FILE="/var/log/backup/system-backup.log"

# Create log directory
mkdir -p "$(dirname "$LOG_FILE")"

# Logging function
log() {
    echo "[$TIMESTAMP] $1" | tee -a "$LOG_FILE"
}

log "Starting system backup"

# Create backup directory
mkdir -p "$BACKUP_DIR/system/$TIMESTAMP"

# Backup system paths
{% for path in backup_system_paths %}
if [ -d "{{ path }}" ]; then
    log "Backing up {{ path }}"
    rsync -az{{ 'v' if backup_compression else '' }} "{{ path }}/" "$BACKUP_DIR/system/$TIMESTAMP/{{ path | basename }}/"
fi
{% endfor %}

# Cleanup old backups
find "$BACKUP_DIR/system" -type d -mtime +{{ backup_retention_days }} -exec rm -rf {} \; 2>/dev/null || true

log "System backup completed: $BACKUP_DIR/system/$TIMESTAMP"
