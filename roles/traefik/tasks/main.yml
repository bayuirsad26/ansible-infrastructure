---
# Optimized Traefik Role - Container-Native Reverse Proxy
# Streamlined for essential functionality

- name: Validate required variables
  ansible.builtin.assert:
    that:
      - traefik_domain != ""
      - traefik_email != ""
      - ansible_facts['services']['docker.service'] is defined
    fail_msg: "Traefik requires domain, email, and Docker service"
  tags: [traefik, validation]

- name: Create Traefik data directory
  ansible.builtin.file:
    path: "{{ traefik_data_dir }}"
    state: directory
    owner: root
    group: root
    mode: '0755'
  tags: [traefik, setup]

- name: Create Traefik Docker network
  community.docker.docker_network:
    name: "{{ traefik_network }}"
    driver: bridge
    attachable: true
  tags: [traefik, network]

- name: Generate dashboard user passwords
  ansible.builtin.set_fact:
    traefik_dashboard_users_hashed: >-
      {{
        traefik_dashboard_users | map('combine', {
          'password_hash': (item.password | password_hash('bcrypt'))
        }) | list
      }}
  when:
    - traefik_dashboard_enabled
    - traefik_dashboard_auth
    - traefik_dashboard_users | length > 0
  tags: [traefik, auth]

- name: Create Traefik configuration files
  ansible.builtin.template:
    src: "{{ item.src }}"
    dest: "{{ traefik_data_dir }}/{{ item.dest }}"
    mode: '0644'
  loop:
    - { src: "traefik.yml.j2", dest: "traefik.yml" }
    - { src: "dynamic.yml.j2", dest: "dynamic.yml" }
    - { src: "docker-compose.yml.j2", dest: "docker-compose.yml" }
  notify: Restart Traefik
  tags: [traefik, config]

- name: Deploy Traefik container
  community.docker.docker_compose_v2:
    project_src: "{{ traefik_data_dir }}"
    state: present
    wait: true
    wait_timeout: 60
  tags: [traefik, deploy]

- name: Wait for Traefik to be ready
  ansible.builtin.uri:
    url: "http://localhost:{{ traefik_dashboard_port }}/ping"
    method: GET
    status_code: 200
  register: traefik_health
  retries: 10
  delay: 3
  tags: [traefik, verify]

- name: Display Traefik configuration
  ansible.builtin.debug:
    msg:
      - "Traefik deployed successfully"
      - "Dashboard: https://{{ traefik_dashboard_subdomain }}.{{ traefik_domain }}"
      - "Network: {{ traefik_network }}"
      - "Let's Encrypt: {{ 'Enabled' if traefik_letsencrypt_enabled else 'Disabled' }}"
      - "Health: {{ 'Healthy' if traefik_health.status == 200 else 'Unhealthy' }}"
      - "HTTP: {{ traefik_web_port }}, HTTPS: {{ traefik_websecure_port }}"
  tags: [traefik, info]
